#!/bin/bash
set -euo pipefail

# Locate the folder containing the script, even if called through a symlink
script_folder="$(cd "$(dirname "$(realpath "$0")")" && pwd)"

launch_agents_folder="$HOME/Library/LaunchAgents"
run_task_path="$script_folder/run-task.sh"

bundle_id_prefix="com.kconner.scheduled-tasks"

usage() {
    echo "Usage: $0 [subcommand] [arguments]"
    echo ""
    echo "subcommands: list (default), create, remove, logs, help"
    echo ""
    echo "$0 create <task-name> (daily|hourly|<number of minutes>) <command>"
    echo "$0 remove <task-name>"
    echo "$0 logs <task-name>"
}

list_tasks() {
    local found=false
    for plist in "$launch_agents_folder"/"$bundle_id_prefix".*.plist; do
        if [[ -f "$plist" ]]; then
            found=true
            local basename
            basename=$(basename "$plist" .plist)
            local task_name=${basename#"$bundle_id_prefix."}
            local status="unloaded"
            
            if launchctl list | grep -q "$bundle_id_prefix.$task_name"; then
                status="loaded"
            fi
            
            printf "%-20s [%s]\n" "$task_name" "$status"
        fi
    done
    
    if [[ "$found" = false ]]; then
        echo "No scheduled tasks."
    fi
}

seconds_for_task_interval() {
    case "$1" in
        daily) echo "86400" ;;
        hourly) echo "3600" ;;
        *) echo "$(($1 * 60))" ;;
    esac
}

escaped_text_for_xml() {
    local text="$1"
    text="${text//&/&amp;}"
    text="${text//</&lt;}"
    text="${text//>/&gt;}"
    text="${text//\"/&quot;}"
    text="${text//\'/&apos;}"
    echo "$text"
}

create_plist() {
    local task_name="$1"
    local interval_seconds="$2"
    local command="$3"
    local plist_file="$launch_agents_folder/$bundle_id_prefix.$task_name.plist"
   
    local escaped_command
    escaped_command=$(escaped_text_for_xml "$command")
    
    # Use a symlink to run-task.sh named after the task, so users can tell
    # multiple background tasks apart in System Settings.
    
    local symlink_path="$script_folder/tasks/$task_name"
    ln -sf "$run_task_path" "$symlink_path"
    
    # Note that in PATH we're including Homebrew's usual binary locations,
    # in case your script is going to need utilities there.
    
    cat > "$plist_file" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>$bundle_id_prefix.$task_name</string>
    
    <key>ProgramArguments</key>
    <array>
        <string>$symlink_path</string>
        <string>$task_name</string>
        <string>$escaped_command</string>
    </array>
    
    <key>StartInterval</key>
    <integer>$interval_seconds</integer>
    
    <key>RunAtLoad</key>
    <false/>
    
    <key>StandardOutPath</key>
    <string>/tmp/$bundle_id_prefix.$task_name.stdout</string>
    
    <key>StandardErrorPath</key>
    <string>/tmp/$bundle_id_prefix.$task_name.stderr</string>
    
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
    </dict>
</dict>
</plist>
EOF
    
    echo "$plist_file"
}

create_task() {
    local task_name="$1"
    local interval="$2"
    local command="$3"
    
    if [[ ! "$task_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo "Error: Task name must contain only letters, numbers, hyphens, and underscores"
        return 1
    fi
    
    if [[ "$interval" != "daily" && "$interval" != "hourly" ]]; then
        if [[ ! "$interval" =~ ^[0-9]+$ ]]; then
            echo "Error: Interval must be 'daily', 'hourly', or a number of minutes"
            return 1
        fi
        
        # Check for a sane interval range (1 minute to 1 week)
        if [[ "$interval" -lt 1 || "$interval" -gt 10080 ]]; then
            echo "Error: Custom interval must be between 1 and 10080 minutes (1 week)"
            return 1
        fi
    fi
    
    local interval_seconds
    interval_seconds=$(seconds_for_task_interval "$interval")
    
    if [[ -f "$launch_agents_folder/$bundle_id_prefix.$task_name.plist" ]]; then
        echo "Error: Task '$task_name' already exists. Remove it first with 'remove'"
        return 1
    fi
    
    local plist_file
    plist_file=$(create_plist "$task_name" "$interval_seconds" "$command")
    echo "Created plist: $plist_file"
    
    echo "Loading task…"
    launchctl load "$plist_file"
    
    if launchctl list | grep -q "$bundle_id_prefix.$task_name"; then
        echo "Created and loaded task '$task_name'."
        elif [[ "$interval" == "daily" ]]; then
            echo "It will run every 24 hours."
        if [[ "$interval" == "hourly" ]]; then
            echo "It will run every hour."
        else
            echo "It will run every $interval minutes."
        fi
    else
        echo "Error: Failed to load task"
        return 1
    fi
}

remove_task() {
    local task_name="$1"
    local plist_file="$launch_agents_folder/$bundle_id_prefix.$task_name.plist"
    
    if [[ ! -f "$plist_file" ]]; then
        echo "Error: Task '$task_name' not found"
        return 1
    fi
    
    if launchctl list | grep -q "$bundle_id_prefix.$task_name"; then
        echo "Unloading task…"
        launchctl unload "$plist_file"
    fi
    
    rm -f "$plist_file"
    
    local symlink_path="$script_folder/tasks/$task_name"
    if [[ -L "$symlink_path" ]]; then
        unlink "$symlink_path"
    fi
    
    echo "Task '$task_name' removed."
}

show_logs() {
    local task_name="$1"
    local log_file="$script_folder/logs/$task_name.log"
    
    if [[ ! -f "$log_file" ]]; then
        echo "No logs found for task '$task_name'"
        return 1
    fi
    
    echo "Recent logs for task '$task_name':"
    tail -n 50 "$log_file"
}

main() {
    case "${1:-}" in
        ""|list)
            list_tasks
            ;;
        
        create)
            if [[ $# -lt 4 ]]; then
                echo "Error: Insufficient arguments"
                usage
                exit 1
            fi
            create_task "$2" "$3" "$4"
            ;;
        
        remove)
            if [[ -z "${2:-}" ]]; then
                echo "Error: Task name required"
                usage
                exit 1
            fi
            remove_task "$2"
            ;;
        
        logs)
            if [[ -z "${2:-}" ]]; then
                echo "Error: Task name required"
                usage
                exit 1
            fi
            show_logs "$2"
            ;;
        
        help|--help|-h)
            usage
            ;;
        
        *)
            echo "Error: Unknown option '$1'"
            usage
            exit 1
            ;;
    esac
}

main "$@"
